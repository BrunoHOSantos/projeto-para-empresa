<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>SEW-Usinagem-de-Aço</title>

  <!-- Bootstrap CSS -->
  <link 
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" 
    rel="stylesheet">
</head>
<body>

  <!-- Bootstrap JS (com Popper) -->
  <script 
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js">
  </script>


<!-- ------------------Navbar---------------- -->
<nav id="navbar1" class="navbar bg-body-tertiary">
  <div class="container-fluid d-flex align-items-center">

    <span class="me-auto">Usinagem de Aço</span>

    <!-- LETREIRO DIGITAL -->
    <div id="letreiro-container">
      <div id="letreiro-texto"></div>
    </div>

    <button id="botao-nav1" class="btn btn-outline-secondary me-2" type="button">
      Entrar
    </button>

    <button id="botao-nav2" class="btn btn-sm btn-outline-danger" type="button">
      <img id="img-sair" src="icons/sair2.png" alt="">
    </button>

  </div>
</nav>

<!-- ---------------------------------------- -->


<!-- ----------------Barra lateral------------------->
    <div class="sidebar" id="sidebar">
      <img id="img-sew" src="/icons/_grandesite-removebg-preview.png" alt="">
      <button class="toggle-btn" onclick="toggleSidebar()">☰</button>

    <ul>
    <a id="click1" href="../index.html"><span>
      <img id="icons-barra" src="../icons/casinha2.png" alt="">
    </span ><p id="espaco">Início</p></a>
    <a id="click2" href="mailto:contato@empresa.com
    ?subject=Relatório%20CSV
    &body=Olá,%0AGostaria%20de%20falar%20sobre%20o%20relatório."><span>
      <img id="icons-barra2" src="../icons/email2.png" alt="">
    </span ><p id="espaco">E-mail</p></a>
    <a id="click3"><span>
      <img id="icons-barra3" src="../icons/grafico2.png" alt="">
    </span ><p id="espaco">Capacidade Anual</p></a>
    <a id="click4"><span>
      <img id="icons-barra4" src="../icons/mensal2.png" alt="">
    </span ><p id="espaco">Capacidad Mensal</p></a>
    <a href="#" id="loginLink" class="sidebar-link"><span>
      <img id="icons-barra5" src="../icons/usuario2.png" alt="">
    </span ><p id="espaco">Usuario</p></a>
    <a id="click6"><span>
      <img id="icons-barra6" src="../icons/config2.png" alt="">
    </span ><p id="espaco">Configurações</p></a>
    <a href="#" id="userInfo" class="sidebar-link hidden">
  <span id="userName"></span>
</a>
  </ul>
    </div>

      <div id="loginModal" class="login-modal hidden">
  <div class="login-box">
    <h2>Login</h2>
    <img id="login-sew" src="/icons/@grandesite.png" alt="">
    <form id="loginForm">
      <input type="text" id="loginUser" placeholder="Usuário" autocomplete="username">
      <input type="password" id="loginPass" placeholder="Senha" autocomplete="current-password">
    </form>
    
    <div class="login-actions">
      <button type="button" id="btnLogin" class="btn btn-outline-secondary me-2">Entrar</button>
      <button type="button" id="btnClose" class="btn btn-outline-secondary me-2">Cancelar</button>
    </div>
  </div>
</div>
<!-- --------------------------------------------- -->
<!-- ---------------------Layout Excel------------ -->

<div id="loading" class="d-flex justify-content-center align-items-center" style="height: 60vh;">
  <div class="spinner-border" style="width: 6rem; height: 6rem;" role="status">
    <span class="visually-hidden">Carregando...</span>
  </div>
</div>

<div id="excelWindow" class="excel-container">
  <table id="excelTable">
    <thead></thead>
    <tbody></tbody>
  </table>
</div>

<!-- ------------------------- -->
 

<!-- --------------------backend------------------ -->
  
 
  <script>
    const sidebar = document.getElementById('sidebar');
    const navbar = document.getElementById('navbar1');
    const excel = document.getElementById('excelWindow');
    
    function toggleSidebar() {
      sidebar.classList.toggle('expand');
      navbar.classList.toggle('sidebar-expand');
      excel.classList.toggle('sidebar-expand');
    }
    </script>

    <script src="../centrosDeCusto.js"></script>

    <script>
      const PREDIO_ATUAL = "120";
    </script>

  <script>
    let dadosOriginais = [];
    let dadosFiltrados = [];

fetch('/dados/EXPORT.csv')
  .then(res => res.text())
  .then(csv => {
    const linhas = csv.split(/\r?\n/).filter(l => l.trim() !== '');
    const thead = document.querySelector('#excelTable thead');
    const tbody = document.querySelector('#excelTable tbody');

    const colunas = linhas[0].split(';'); // ajuste para ',' se necessário
    const CENTRO_TRABALHO_COL = colunas.findIndex(col =>
  col.toLowerCase().includes("trabalho")
);



    
    dadosOriginais = linhas.slice(1)
  .map(l => l.split(';'))
  .filter(linha => {
    const centro = Number(
      linha[CENTRO_TRABALHO_COL]
        ?.replace(/\D/g, '')
    );
    return centrosPorPredio[PREDIO_ATUAL]?.includes(centro);
  });
    dadosFiltrados = [...dadosOriginais];

    console.log("Índice Centro de Trabalho:", CENTRO_TRABALHO_COL);
console.log(
  "Exemplos:",
  linhas.slice(1, 10).map(l =>
    l.split(';')[CENTRO_TRABALHO_COL]
  )
);

    // ===== CABEÇALHO COM FILTRO =====
    let headerHTML = '<tr>';
    colunas.forEach(col => headerHTML += `<th>${col}</th>`);
    headerHTML += '</tr>';

    let filterHTML = '<tr>';
    colunas.forEach((_, index) => {
      filterHTML += `
        <th>
          <input 
            type="text" 
            data-col="${index}" 
            placeholder="Filtrar..."
            class="filtro-coluna"
          >
        </th>`;
    });
    filterHTML += '</tr>';

    thead.innerHTML = headerHTML + filterHTML;
    
    renderTabela(dadosFiltrados);

      // esconder loading
      document.getElementById('loading').style.display = 'none';

      // mostrar tabela
      document.getElementById('excelTable').style.display = 'table';

      // 1. esconder spinner
      const loading = document.getElementById('loading');
      loading.classList.add('hide');

      setTimeout(() => {
        loading.style.display = 'none';

        // 2. forçar reflow (importante!)
        const excel = document.getElementById('excelWindow');
        excel.offsetHeight; // força o navegador a registrar o estado inicial

        // 3. agora sim dispara a animação
        excel.classList.add('show');
      }, 300);

        // mostrar tabela com efeito
        document.getElementById('excelWindow').classList.add('show');

    // ===== EVENTO DOS FILTROS =====
    document.querySelectorAll('.filtro-coluna').forEach(input => {
      input.addEventListener('input', aplicarFiltros);
      
    });
    })
      .catch(err => {
        // se der qualquer erro no fetch ou no processamento
        const loading = document.getElementById('loading');
        loading.innerHTML =
          '<div class="text-danger fw-bold">Erro ao carregar os dados.</div>';
        console.error('Erro ao carregar CSV:', err);
      });


  
  
// ===== FILTRAGEM =====
function aplicarFiltros() {
  const filtros = document.querySelectorAll('.filtro-coluna');

  dadosFiltrados = dadosOriginais.filter(linha => {
    return Array.from(filtros).every(input => {
      const index = input.dataset.col;
      const valorFiltro = input.value.toLowerCase();
      const valorCelula = linha[index]?.toLowerCase() || '';
      return valorCelula.includes(valorFiltro);
    });
  });
  

  renderTabela(dadosFiltrados);
}


// ===== RENDER =====
function renderTabela(dados) {
  const tbody = document.querySelector('#excelTable tbody');
  let html = '';

  dados.forEach(linha => {
    html += '<tr>';
    linha.forEach(celula => {
      html += `<td>${celula}</td>`;
    });
    html += '</tr>';
  });

  tbody.innerHTML = html;
}
</script>

<!-- ------------------Front-end------------------ -->
  <link rel="stylesheet" href="../style.css">
<!-- --------------------backend------------------ -->

  <script src="../javascipt.js"></script>

  <script>
  function toggleSidebar() {
    document.getElementById("sidebar").classList.toggle("expand");
  }
</script>

<script>
  function toggleSidebar() {
    const sidebar = document.getElementById("sidebar");
    const navbar = document.getElementById("navbar1");

    sidebar.classList.toggle("expand");
    navbar.classList.toggle("sidebar-expand");
  }
</script>


<!-- --------------------------------------------- -->
</body>
</html>